---
import Navigation from '../components/Navigation.astro'
import { DarkMode, SkipLink } from 'accessible-astro-components'
import { Icon } from 'astro-icon/components'

import { getCollection } from 'astro:content'

const pages = await getCollection('pages', ({ data }) => data.published)

// normalize helper
function normalizeHref(page) {
  let href = page.data.linkUrl ?? `/${page.slug}/`
  if (href && !href.startsWith('/')) href = '/' + href
  return href
}

// split into "direct" vs "grouped"
// Group pages by first slug segment (top-level folder)
const grouped = {}
const direct = []

for (const page of pages) {
  const parts = page.slug.split('/')
  if (parts.length === 1) {
    direct.push(page)
  } else {
    const top = parts[0]
    if (!grouped[top]) grouped[top] = []
    grouped[top].push(page)
  }
}

// optional ordering
direct.sort((a, b) => (a.data.navOrder ?? 0) - (b.data.navOrder ?? 0))
for (const key in grouped) {
  grouped[key].sort((a, b) => (a.data.navOrder ?? 0) - (b.data.navOrder ?? 0))
}

/**
 * Header Component
 *
 * @description A component that displays the header of the website
 */
---

<header>
  <SkipLink />
  <Navigation>
    <li class="menu-item">
      <a href="/" title="Build on TitanX - Home">Home</a>
    </li>

    <!-- {
      pages.map((page) => (
        <li class="menu-item">
          <a href={`/${page.slug}/`} title={`${page.data.title} - ${page.data.description ?? ''}`}>
            {page.data.title}
          </a>
        </li>
      ))
    } -->
    {
      direct.map((page) => {
        const href = normalizeHref(page)
        return (
          <li class="menu-item">
            <a href={href} title={`${page.data.title} - ${page.data.description ?? ''}`}>
              {page.data.title}
            </a>
          </li>
        )
      })
    }

    {
      Object.entries(grouped).map(([folder, items]) => {
        if (items.length === 1 && folder === items[0].slug) {
          const page = items[0]
          const href = normalizeHref(page)
          return (
            <li class="menu-item">
              <a href={href} title={`${page.data.title} - ${page.data.description ?? ''}`}>
                {page.data.title}
              </a>
            </li>
          )
        } else {
          return (
            <li class="menu-item has-dropdown">
              <button
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls={`${folder}-dropdown`}
                title={`${folder} Menu`}
              >
                {folder[0].toUpperCase() + folder.slice(1)}
                <Icon name="lucide:chevron-down" size="32" />
              </button>
              <ul class="dropdown-menu" id={`${folder}-dropdown`}>
                {items.map((page) => {
                  const href = normalizeHref(page)
                  return (
                    <li class="submenu-item">
                      <a href={href} title={`${page.data.title} - ${page.data.description ?? ''}`}>
                        {page.data.title}
                      </a>
                    </li>
                  )
                })}
              </ul>
            </li>
          )
        }
      })
    }

    <!-- <li class="menu-item">
      <a href="/about/" title="About TitanX - Vision and Ethos">About</a>
    </li> -->
    <!-- <li class="menu-item">
      <a href="/how-it-works/" title="How TitanX Works - Tokenomics and Governance">How It Works</a>
    </li> -->
    <li class="menu-item has-dropdown">
      <button aria-haspopup="true" aria-expanded="false" aria-controls="developers-dropdown" title="Developers Menu">
        Developers
        <Icon name="lucide:chevron-down" size="32" />
      </button>
      <ul class="dropdown-menu" id="developers-dropdown">
        <li class="submenu-item">
          <a href="/developers/overview/" title="Developer Overview and Build Philosophy">Overview</a>
        </li>
        <li class="submenu-item">
          <a href="/developers/docs/" title="API Documentation and Smart Contract Specs">Docs</a>
        </li>
        <li class="submenu-item">
          <a href="https://github.com/titanx" title="TitanX GitHub Repositories" target="_blank" rel="noopener"
            >GitHub</a
          >
        </li>
        <li class="submenu-item">
          <a href="/developers/tutorials/" title="Step-by-Step Integration Tutorials">Tutorials</a>
        </li>
        <li class="submenu-item">
          <a href="/developers/tools/" title="SDKs, CLI Tools, and Testing Environments">Tools</a>
        </li>
      </ul>
    </li>
    <li class="menu-item has-dropdown">
      <button aria-haspopup="true" aria-expanded="false" aria-controls="resources-dropdown" title="Resources Menu">
        Resources
        <Icon name="lucide:chevron-down" size="32" />
      </button>
      <ul class="dropdown-menu" id="resources-dropdown">
        <li class="submenu-item">
          <a href="/blog/" title="TitanX Blog - Updates and Insights">Blog</a>
        </li>
        <li class="submenu-item">
          <a href="/faqs/" title="Frequently Asked Questions">FAQs</a>
        </li>
        <li class="submenu-item">
          <a href="/media-kit/" title="Media Kit and Brand Assets">Media Kit</a>
        </li>
        <li class="submenu-item">
          <a href="/press/" title="Press Coverage and Releases">Press</a>
        </li>
        <li class="submenu-item">
          <a href="/status/" title="System Status and Incident Reports">Status</a>
        </li>
      </ul>
    </li>
    <li class="menu-item">
      <a href="/community/" title="Community Forums and Chat">Community</a>
    </li>
    <!-- <li class="menu-item">
      <a href="/get-started/" title="Getting Started with TitanX Wallet and Staking">Get Started</a>
    </li> -->

    <!-- <Navigation>
    <li class="menu-item">
      <a href="/">Home</a>
    </li>
    <li class="menu-item">
      <a href="/entries/">Entries</a>
    </li>
    <li class="menu-item">
      <a href="/pagescms/">pages-cms</a>
    </li>
    <li class="menu-item">
      <a href="/blog/">Blog</a>
    </li>
    <li class="menu-item">
      <a href="/portfolio/">Portfolio</a>
    </li>
    <li class="menu-item has-dropdown">
      <button aria-haspopup="true" aria-expanded="false">
        Theme features
        <Icon name="lucide:chevron-down" size="32" />
      </button>
      <ul class="dropdown-menu">
        <li class="submenu-item">
          <a href="/accessibility-statement">Accessibility statement</a>
        </li>
        <li class="submenu-item">
          <a href="/accessible-components">Accessible components</a>
        </li>
        <li class="submenu-item">
          <a href="/color-contrast-checker">Color contrast checker</a>
        </li>
        <li class="submenu-item">
          <a href="/markdown-page/">Markdown page</a>
        </li>
        <li class="submenu-item">
          <a href="/mdx-page/">MDX page</a>
        </li>
        <li class="submenu-item">
          <a href="/404-page">404 page</a>
        </li>
      </ul>
    </li> -->
    <!-- the following highlight weirdly gets set to is-active!? -->
    <!-- <li class="menu-item highlight">
      <a href="https://accessible-astro.incluud.dev/">Docs </a>
    </li>
    <li class="menu-item type-icon animate-rotate">
      <a href="https://github.com/markteekman/accessible-astro-starter">
        <Icon name="lucide:github" />
        <span class="sr-only">Go to the GitHub page</span>
      </a>
    </li> -->
    <li class="menu-item type-icon animate-rotate">
      <DarkMode>
        <span slot="light">
          <Icon name="lucide:moon" />
        </span>
        <span slot="dark">
          <Icon name="lucide:sun" />
        </span>
      </DarkMode>
    </li>
  </Navigation>
</header>

<style lang="scss" is:global>
  header {
    .type-icon {
      display: block;
      margin-inline: -7px;

      svg {
        inline-size: 30px;
        block-size: 30px;
      }
    }
  }
</style>
