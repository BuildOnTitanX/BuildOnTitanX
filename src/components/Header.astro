---
import Navigation from '../components/Navigation.astro'
import { DarkMode, SkipLink } from 'accessible-astro-components'
import { Icon } from 'astro-icon/components'

import { getCollection } from 'astro:content'

const pages = await getCollection('pages', ({ data }) => data.published)

function checkLinkUrlOverride(page) {
  if (page.data.linkUrl) {
    let href = page.data.linkUrl.trim()

    // If it's not starting with "/" and not absolute URL, prepend "/"
    if (!href.startsWith('/') && !/^https?:\/\//i.test(href)) {
      href = '/' + href
    }

    // External link check
    const isExternal = /^https?:\/\//i.test(href)

    return {
      href,
      ...(isExternal ? { target: '_blank', rel: 'noopener noreferrer' } : {}),
    }
  } else {
    return { href: `/${page.slug}/` }
  }
}

// split into "direct" vs "grouped"
// Group pages by first slug segment (top-level folder)
const grouped = {}
const direct = []

for (const page of pages) {
  const parts = page.slug.split('/')
  if (parts.length === 1) {
    direct.push(page)
  } else {
    const top = parts[0]
    if (!grouped[top]) grouped[top] = []
    grouped[top].push(page)
  }
}

// optional ordering
direct.sort((a, b) => (a.data.navOrder ?? 0) - (b.data.navOrder ?? 0))
for (const key in grouped) {
  grouped[key].sort((a, b) => (a.data.navOrder ?? 0) - (b.data.navOrder ?? 0))
}

/**
 * Header Component
 *
 * @description A component that displays the header of the website
 */
---

<header>
  <SkipLink />
  <Navigation>
    <li class="menu-item">
      <a href="/" title="Build on TitanX - Home">Home</a>
    </li>

    <!-- {
      pages.map((page) => (
        <li class="menu-item">
          <a href={`/${page.slug}/`} title={`${page.data.title} - ${page.data.description ?? ''}`}>
            {page.data.title}
          </a>
        </li>
      ))
    } -->
    {
      direct.map((page) => {
        const { href, target, rel } = checkLinkUrlOverride(page)
        return (
          <li class="menu-item">
            <a href={href} target={target} rel={rel} title={`${page.data.title} - ${page.data.description ?? ''}`}>
              {page.data.title}
            </a>
          </li>
        )
      })
    }

    {
      Object.entries(grouped).map(([folder, items]) => {
        if (items.length === 1 && folder === items[0].slug) {
          const page = items[0]
          const { href, target, rel } = checkLinkUrlOverride(page)
          return (
            <li class="menu-item">
              <a href={href} target={target} rel={rel} title={`${page.data.title} - ${page.data.description ?? ''}`}>
                {page.data.title}
              </a>
            </li>
          )
        } else {
          return (
            <li class="menu-item has-dropdown">
              <button
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls={`${folder}-dropdown`}
                title={`${folder} Menu`}
              >
                {folder[0].toUpperCase() + folder.slice(1)}
                <Icon name="lucide:chevron-down" size="32" />
              </button>
              <ul class="dropdown-menu" id={`${folder}-dropdown`}>
                {items.map((page) => {
                  const { href, target, rel } = checkLinkUrlOverride(page)
                  return (
                    <li class="submenu-item">
                      <a
                        href={href}
                        target={target}
                        rel={rel}
                        title={`${page.data.title} - ${page.data.description ?? ''}`}
                      >
                        {page.data.title}
                      </a>
                    </li>
                  )
                })}
              </ul>
            </li>
          )
        }
      })
    }

    <!-- <li class="menu-item">
      <a href="/about/" title="About TitanX - Vision and Ethos">About</a>
    </li> -->
    <!-- <li class="menu-item">
      <a href="/how-it-works/" title="How TitanX Works - Tokenomics and Governance">How It Works</a>
    </li> -->
    <!-- <li class="menu-item has-dropdown">
      <button aria-haspopup="true" aria-expanded="false" aria-controls="developers-dropdown" title="Developers Menu">
        Developers
        <Icon name="lucide:chevron-down" size="32" />
      </button>
      <ul class="dropdown-menu" id="developers-dropdown">
        <li class="submenu-item">
          <a href="/developers/overview/" title="Developer Overview and Build Philosophy">Overview</a>
        </li>
        <li class="submenu-item">
          <a href="/developers/docs/" title="API Documentation and Smart Contract Specs">Docs</a>
        </li>
        <li class="submenu-item">
          <a
            href="https://github.com/titanx"
            title="TitanX GitHub Repositories"
            target="_blank"
            rel="noopener noreferrer">GitHub</a
          >
        </li>
        <li class="submenu-item">
          <a href="/developers/tutorials/" title="Step-by-Step Integration Tutorials">Tutorials</a>
        </li>
        <li class="submenu-item">
          <a href="/developers/tools/" title="SDKs, CLI Tools, and Testing Environments">Tools</a>
        </li>
      </ul>
    </li> -->
    <li class="menu-item has-dropdown">
      <button aria-haspopup="true" aria-expanded="false" aria-controls="resources-dropdown" title="Resources Menu">
        Resources
        <Icon name="lucide:chevron-down" size="32" />
      </button>
      <ul class="dropdown-menu" id="resources-dropdown">
        <li class="submenu-item">
          <a href="/blog/" title="TitanX Blog - Updates and Insights">Blog</a>
        </li>
        <li class="submenu-item">
          <a href="/faqs/" title="Frequently Asked Questions">FAQs</a>
        </li>
        <li class="submenu-item">
          <a href="/media-kit/" title="News">News</a>
        </li>
      </ul>
    </li>
    <li class="menu-item has-dropdown">
      <button aria-haspopup="true" aria-expanded="false" aria-controls="resources-dropdown" title="Resources Menu">
        Community Links
        <Icon name="lucide:chevron-down" size="32" />
      </button>
      <ul class="dropdown-menu" id="resources-dropdown">
        <li class="submenu-item">
          <a
            href="https://www.titanx.win/"
            target="_blank"
            rel="noopener noreferrer"
            title="TitanX Website - Mainpage explaining its Phylosophy">TitanX Mainpage</a
          >
        </li>
        <li class="submenu-item">
          <a
            href="https://app.titanx.win/stats"
            target="_blank"
            rel="noopener noreferrer"
            title="TitanX Dapp - Focusing on the Stats">TitanX Dapp Stats</a
          >
        </li>
        <li class="submenu-item">
          <a href="https://www.titanxhub.com/" target="_blank" rel="noopener noreferrer" title="Titan X Hub"
            >Titan X Hub</a
          >
        </li>
        <li class="submenu-item">
          <a
            href="https://titanfarms.win/"
            target="_blank"
            rel="noopener noreferrer"
            title="The TitanX Farms - Simply add LP and earn TINC">Titan Farms</a
          >
        </li>
        <li class="submenu-item">
          <a
            href="https://titanxinfo.com/"
            target="_blank"
            rel="noopener noreferrer"
            title="TitanXInfo -
            TITANX Crypto For Beginners">TitanXInfo</a
          >
        </li>
        <li class="submenu-item">
          <a
            href="https://www.titanxutils.com/"
            target="_blank"
            rel="noopener noreferrer"
            title="TitanXUtils - Your comprehensive dashboard for the TitanX ecosystem">TitanXUtils</a
          >
        </li>
      </ul>
    </li>
    <!-- <li class="menu-item">
      <a href="/community/" title="Community Forums and Chat">Community</a>
    </li> -->
    <!-- <li class="menu-item">
      <a href="/get-started/" title="Getting Started with TitanX Wallet and Staking">Get Started</a>
    </li> -->

    <!-- <Navigation>
    <li class="menu-item">
      <a href="/">Home</a>
    </li>
    <li class="menu-item">
      <a href="/entries/">Entries</a>
    </li>
    <li class="menu-item">
      <a href="/pagescms/">pages-cms</a>
    </li>
    <li class="menu-item">
      <a href="/blog/">Blog</a>
    </li>
    <li class="menu-item">
      <a href="/portfolio/">Portfolio</a>
    </li>
    <li class="menu-item has-dropdown">
      <button aria-haspopup="true" aria-expanded="false">
        Theme features
        <Icon name="lucide:chevron-down" size="32" />
      </button>
      <ul class="dropdown-menu">
        <li class="submenu-item">
          <a href="/accessibility-statement">Accessibility statement</a>
        </li>
        <li class="submenu-item">
          <a href="/accessible-components">Accessible components</a>
        </li>
        <li class="submenu-item">
          <a href="/color-contrast-checker">Color contrast checker</a>
        </li>
        <li class="submenu-item">
          <a href="/markdown-page/">Markdown page</a>
        </li>
        <li class="submenu-item">
          <a href="/mdx-page/">MDX page</a>
        </li>
        <li class="submenu-item">
          <a href="/404-page">404 page</a>
        </li>
      </ul>
    </li> -->
    <!-- the following highlight weirdly gets set to is-active!? -->
    <!-- <li class="menu-item highlight">
      <a href="https://accessible-astro.incluud.dev/">Docs </a>
    </li>
    <li class="menu-item type-icon animate-rotate">
      <a href="https://github.com/markteekman/accessible-astro-starter">
        <Icon name="lucide:github" />
        <span class="sr-only">Go to the GitHub page</span>
      </a>
    </li> -->
    <li class="menu-item type-icon animate-rotate">
      <DarkMode>
        <span slot="light">
          <Icon name="lucide:moon" />
        </span>
        <span slot="dark">
          <Icon name="lucide:sun" />
        </span>
      </DarkMode>
    </li>
  </Navigation>
</header>

<style lang="scss" is:global>
  header {
    .type-icon {
      display: block;
      margin-inline: -7px;

      svg {
        inline-size: 30px;
        block-size: 30px;
      }
    }
  }
</style>
